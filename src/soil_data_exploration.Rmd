---
title: "Soil Data Exploration"
author: "German Silva"
date: "3/4/2022"
output: html_document
---

```{r setup, include=FALSE, message=FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning = FALSE)

# significance tests and data exploration
library(tidyverse)
library(here)
library(kableExtra)
library(ggbeeswarm)


# spatial analysis
library(sf)
library(tmap)
library(maptools)
library(gstat)
library(stars)
library(SpatialKDE)
```

```{r}
soils <- read_sf(here("data", "soil_w_elevation.shp")) %>% 
  mutate(date = lubridate::ymd(date),
         electro_co = as.numeric(electro_co)) %>%
  select(date:transect, meter_loca, electro_co, dem) %>% 
  drop_na()
  

dem <- read_stars(here("data", "dem.tif")) %>% 
  st_extract(soils$geometry)


samples <- read_sf(here("data", "sampling_points.shp"))

sample_ids <- read_csv(here("data", "sample_ids.csv"))

```


```{r}
ggplot(soils, aes(x = dem, y = electro_co, color = transect)) +
  geom_point()+
  scale_x_continuous(breaks = seq(2,2.7, 0.05))+
  theme(legend.position = "none")+
  ggtitle("Soil Electro Conductivity All Sites")

ggplot(soils, aes(x = meter_location, y = electro_cond_mS_per_cm, color = transect)) +
  geom_point()+
  ggtitle("Soil Electro Conductivity All Sites")

soils %>% 
  group_by(transect, meter_location) %>% 
  summarize(mean = mean(electro_cond_mS_per_cm),
            dev = sd(electro_cond_mS_per_cm),
            variance = var(electro_cond_mS_per_cm)) %>% 
  kableExtra::kable() %>% 
  kableExtra::kable_classic(lightable_options = "striped")

```


```{r}
ggplot(soils, aes(x = water_content_percent, y = electro_cond_mS_per_cm, color = transect)) +
  geom_point()+
  ggtitle("Soil Electro Conductivity All Sites")
```

```{r}
samples_sf <- sample_ids %>% 
  drop_na() %>% 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326)

tmap_mode("view")

tm_shape(samples) +
  tm_dots()+
  tm_shape(samples_sf) +
  tm_dots(col = "red") 
  
```



```{r}
strip_labels <- c("COPR_1_EW" = "COPR 1 EW",
                  "COPR_2_EW" = "COPR 2 EW",
                  "COPR_2_NS" = "COPR 2 NS",
                  "NCOS_1_NS" = "NCOS 1 NS",
                  "NCOS_2_EW" = "NCOS 2 EW",
                  "NCOS_2_NS" = "NCOS 2 NS")
soils <- soils %>% 
  mutate(date = lubridate::ymd(date),
         week = lubridate::week(date)) 
  

ggplot(soils, aes(x = dem, y = electro_co, color = transect)) +
  geom_point()+
  scale_color_manual(values = calecopal::cal_palette(name = "superbloom3", n =6, type = "discrete"))+
  facet_wrap(~transect, labeller = as_labeller(strip_labels))+
  theme(legend.position = "none")+
  labs(x = "Elevation (m)",
       y = "Electrical conductivity (mS/cm)")+
  ggtitle("Soil Electroconductivity All Sites")+
  theme(plot.title = element_text(color = "#5b4f41", size = 16, hjust = 0.5),
        plot.background = element_rect("white"),
        panel.background = element_rect("#faf7f2"),
        panel.grid = element_line(linetype= "longdash", color = "#f0ece1"),
        axis.text = element_text(color = "#5b4f41"),
        axis.title = element_text(color = "#5b4f41"),
        strip.background = element_rect("#f8f8f8"),
        strip.text = element_text(color = "#5b4f41"),
        axis.line = element_line(color = "#5b4f41"))
  
```

```{r}
soil_stats <- soils %>% 
  group_by(transect) %>% 
  summarize(mean = mean(electro_cond_mS_per_cm),
            max = max(electro_cond_mS_per_cm),
            min = min(electro_cond_mS_per_cm),
            range = max - min)
```
 
 