---
title: "Soil Data Exploration"
author: "German Silva"
date: "3/4/2022"
output: html_document
---

```{r setup, include=FALSE, message=FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning = FALSE)

# significance tests and data exploration
library(tidyverse)
library(here)
library(kableExtra)
library(ggbeeswarm)
library(broom)
library(randomForest)
library(caret)

# spatial analysis
library(sf)
library(tmap)
library(maptools)
library(gstat)
library(stars)
library(SpatialKDE)
```

```{r}
soils <- read_csv(here("data", "shift_soil_data.csv")) %>% 
  mutate(date = lubridate::mdy(date)) %>%
  select(soil_id:transect, meter_location, electro_cond_mS_per_cm, water_content_percent, season, latitude, longitude) %>% 
  drop_na()

soils_sf <- read_sf(here("data", "soil_w_elevation.shp")) %>% 
  select(electro_co, water_cont) %>% 
  mutate(electro_co = as.numeric(electro_co),
         water_cont = as.numeric(water_cont)) %>% 
  drop_na()

bbox <- read_sf(here("data", "bounding_box.shp"))  

dem <- read_stars(here("data", "dem.tif")) %>% 
  st_extract(soils_sf$geometry)

dem_soils <- dem %>% 
  cbind(soils)

samples <- read_sf(here("data", "sampling_points.shp"))

sample_ids <- read_csv(here("data", "sample_ids.csv"))

```


```{r}
soils %>% 
  group_by(transect) %>% 
  summarize(mean = mean(electro_cond_mS_per_cm),
            dev = sd(electro_cond_mS_per_cm),
            variance = var(electro_cond_mS_per_cm)) %>% 
  kableExtra::kable() %>% 
  kableExtra::kable_classic(lightable_options = "striped")

```


```{r}
strip_labels <- c("COPR_1_EW" = "COPR 1 EW",
                  "COPR_2_EW" = "COPR 2 EW",
                  "COPR_2_NS" = "COPR 2 NS",
                  "NCOS_1_NS" = "NCOS 1 NS",
                  "NCOS_2_EW" = "NCOS 2 EW",
                  "NCOS_2_NS" = "NCOS 2 NS")
soils <- soils %>% 
  mutate(date = lubridate::ymd(date),
         week = lubridate::week(date)) 
  

ggplot(dem_soils, aes(x = dem.tif, y = electro_cond_mS_per_cm, color = transect, shape = season)) +
  geom_point()+
  scale_color_manual(values = calecopal::cal_palette(name = "superbloom3", n =6, type = "discrete"))+
  #facet_wrap(~transect, labeller = as_labeller(strip_labels))+
  #theme(legend.position = "none")+
  labs(x = "Elevation (m)",
       y = "Electrical conductivity (mS/cm)")+
  ggtitle("Soil Electrical Conductivity Across Elevations")+
  theme(plot.title = element_text(color = "#5b4f41", size = 16, hjust = 0.5),
        plot.background = element_rect("white"),
        panel.background = element_rect("#faf7f2"),
        panel.grid = element_line(linetype= "longdash", color = "#f0ece1"),
        axis.text = element_text(color = "#5b4f41"),
        axis.title = element_text(color = "#5b4f41"),
        strip.background = element_rect("#f8f8f8"),
        strip.text = element_text(color = "#5b4f41"),
        axis.line = element_line(color = "#5b4f41"))
  
```

```{r}
soil_stats <- soils %>% 
  group_by(transect) %>% 
  summarize(mean = mean(electro_cond_mS_per_cm),
            max = max(electro_cond_mS_per_cm),
            min = min(electro_cond_mS_per_cm),
            range = max - min)
```

```{r}

fit_ele <- randomForest(electro_cond_mS_per_cm ~ dem.tif, data = dem_soils, importance = TRUE)

ggplot()+
  geom_point(aes(x= dem_soils$electro_cond_mS_per_cm, y = fit_ele$predicted), color = "#E69512")+
  geom_smooth(method = "lm", aes(x= dem_soils$electro_cond_mS_per_cm, y = fit_ele$predicted), color =  "#3A5D3D")+
  labs(x = "Actual Electrical Conductivity (mS/cm)",
       y = "Predicted Electrical conductivity (mS/cm)")+
  ggtitle("Soil Electrical Conductivity Predictions by Elevation")+
  theme(plot.title = element_text(color = "#5b4f41", size = 16, hjust = 0.5),
        plot.background = element_rect("white"),
        panel.background = element_rect("#faf7f2"),
        panel.grid = element_line(linetype= "longdash", color = "#f0ece1"),
        axis.text = element_text(color = "#5b4f41"),
        axis.title = element_text(color = "#5b4f41"),
        strip.background = element_rect("#f8f8f8"),
        strip.text = element_text(color = "#5b4f41"),
        axis.line = element_line(color = "#5b4f41"))

elevation_cor <- cor(x= dem_soils$electro_cond_mS_per_cm, y = fit_ele$predicted)
elevation_cor

fit_ele_water <- randomForest(electro_cond_mS_per_cm ~ dem.tif + water_content_percent, data = dem_soils, importance = TRUE)

ggplot()+
  geom_point(aes(x= dem_soils$electro_cond_mS_per_cm, y = fit_ele_water$predicted), color = "#E69512")+
  geom_smooth(method = "lm", aes(x= dem_soils$electro_cond_mS_per_cm, y = fit_ele_water$predicted), color =  "#3A5D3D")+
  labs(x = "Actual Electrical Conductivity (mS/cm)",
       y = "Predicted Electrical conductivity (mS/cm)")+
  ggtitle("Soil Electrical Conductivity Predictions by Elevation and Water Content")+
  theme(plot.title = element_text(color = "#5b4f41", size = 16, hjust = 0.5),
        plot.background = element_rect("white"),
        panel.background = element_rect("#faf7f2"),
        panel.grid = element_line(linetype= "longdash", color = "#f0ece1"),
        axis.text = element_text(color = "#5b4f41"),
        axis.title = element_text(color = "#5b4f41"),
        strip.background = element_rect("#f8f8f8"),
        strip.text = element_text(color = "#5b4f41"),
        axis.line = element_line(color = "#5b4f41"))

ele_water_cor <- cor(x= dem_soils$electro_cond_mS_per_cm, y = fit_ele_water$predicted)
ele_water_cor
```
 
```{r}
sal_pred <- terra::predict(object = read_stars(here("data", "dem.tif")), model = fit_ele)
```
 
```{r}
sal_pred_w_e <- terra::predict(object = read_stars(here("data", "dem.tif")), model = fit_ele_water)
```
 
 
```{r}
ggplot()+
  geom_stars(data = sal_pred) +
  coord_cartesian(ylim = c(34.409, 34.422), xlim = c(-119.882, -119.873))+
  labs(x = "Longitude",
       y = "Latitude")+
  ggtitle("Soil Electrical Conductivity Predictions by Elevation")+
  theme(plot.title = element_text(color = "#5b4f41", size = 16, hjust = 0.5),
        plot.background = element_rect("white"),
        panel.background = element_rect("#faf7f2"),
        panel.grid = element_line(linetype= "longdash", color = "#f0ece1"),
        axis.text = element_text(color = "#5b4f41"),
        axis.title = element_text(color = "#5b4f41"),
        strip.background = element_rect("#f8f8f8"),
        strip.text = element_text(color = "#5b4f41"),
        axis.line = element_line(color = "#5b4f41"))
```
 
 